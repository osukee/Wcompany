name: Attrition Prediction Workflow

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  run-ml-pipeline:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: |
          pip install -r requirements.txt

      - name: Execute & Check (Train Model)
        run: |
          python train.py

      - name: Setup CML
        uses: iterative/setup-cml@v2

      - name: Feedback (Write Report to PR)
        if: github.event_name == 'pull_request'
        env:
          REPO_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # ãƒ¬ãƒãƒ¼ãƒˆã®Markdownã‚’ä½œæˆ
          echo "## ğŸ“Š é›¢è·ç‡äºˆæ¸¬ãƒ¢ãƒ‡ãƒ« ãƒ¬ãƒãƒ¼ãƒˆ" > report.md
          echo "" >> report.md
          echo "### ãƒ¢ãƒ‡ãƒ«ç²¾åº¦ãƒ¡ãƒˆãƒªã‚¯ã‚¹" >> report.md
          echo "\`\`\`" >> report.md
          cat metrics.txt >> report.md
          echo "\`\`\`" >> report.md
          echo "" >> report.md
          
          echo "### æ··åŒè¡Œåˆ— (Confusion Matrix)" >> report.md
          echo "![Confusion Matrix](./confusion_matrix.png)" >> report.md
          echo "" >> report.md
          
          echo "### ç‰¹å¾´é‡é‡è¦åº¦ (Top 10)" >> report.md
          echo "![Feature Importance](./feature_importance.png)" >> report.md
          echo "" >> report.md
          
          echo "### ãƒ‡ãƒ¼ã‚¿ã«ã¤ã„ã¦" >> report.md
          echo "- ä½¿ç”¨ãƒ‡ãƒ¼ã‚¿: data.csv" >> report.md
          echo "- ãƒ¢ãƒ‡ãƒ«: RandomForestClassifier" >> report.md
          echo "" >> report.md
          
          echo "---" >> report.md
          echo "*ã“ã®ãƒ¬ãƒãƒ¼ãƒˆã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ*" >> report.md
          
          # PRã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’é€ä¿¡ (CMLæ©Ÿèƒ½)
          # --publishã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§Markdownå†…ã®ç”»åƒå‚ç…§ã‚’è‡ªå‹•çš„ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
          cml comment create report.md --publish

